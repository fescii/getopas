{% extends "base.html" %}
{% load static %}
{% load blog_tags %}
{% load thumbnail %}
{% block title %}My Publications{% endblock %}
{% block content %}
    {% include "editors/create-header.html" %}
    <div class="my-article-list feed-contents">
        <div class="feed-title">
            <div class="section-title">My Articles</div>
            <i class="iconly-Arrow-Right-Circle icli"></i>
        </div>
        <div class="article-list">
            {% for post in posts %}
                <div class="post-summery">
                    <h2>
                        <a href="{{ post.get_absolute_url }}"> {{ post.title }} </a>
                    </h2>
                    {% comment %} <div class="image-wrapper">
                        {% if post.cover %}
                            <img id="" src="{% thumbnail post.cover 300x0 %}" alt="Post-Image">
                        {% else %}
                            <img src="https://eu.ui-avatars.com/api/?background=23a6d5&name={{post.title}}&size=250&color=fff" alt="article image">
                        {% endif %}
                    </div> {% endcomment %}
                    <form class="image-wrapper" action="{% url 'editors:edit_article_cover' pk=post.id %}" method="post" enctype="multipart/form-data">
                        <div data-id="{{post.id}}" class="avatar-upload">
                            <div class="avatar-edit">
                                <label for="wrapper-{{post.id}}">Select Photo</label>
                                <input type="file" name="photo" accept="image/*" id="wrapper-{{post.id}}">
                            </div>
                            <div class="avatar-preview">
                                <div id="clock" class="clock-{{post.id}}"
                                    {% if post.cover %}
                                    style="background-image: url('..{% thumbnail post.cover 300x0 %}');">
                                    {% else %}
                                        style="background-image: url('https://eu.ui-avatars.com/api/?background=08b86f&name={{post.title}}&size=250&color=fff');">
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% csrf_token %}
                        <input type="submit" value="Update">
                    </form>
                    <div class="date">
                        {% comment %} {{ post.publish|time_lapse }} {% endcomment %}
                        {{ post.publish }}
                    </div>
                    <div class='article-summery'>
                        {{ post.body|striptags|safe|truncatechars:160 }}
                    </div>
                    <div class='article-stats'>
                        {% if post.status == "draft" %}
                            <span class='stats-title'>Drafted</span>
                        {% else %}
                            <span class='stats-title'>Stats</span>
                            <span class='views'><span class="iconly-Show icli"></span> {{ post.blog_views }}</span>
                            <span class='comments'><span class="iconly-User2 icli"></span>{{ post.id|get_article_comments }}</span>
                        {% endif %}
                    </div>
                    <div class="action-links">
                        <a href="/edit-article/{{post.id}}">Edit</a>
                        <a data-id="{{post.id}}" class="edit-article-tags" href="">Tags</a>
                        <a class="delete-article" href="">Delete</a>
                        <div class="delete-article-options">
                            <div class="delete-text">
                                Are you sure you want to delete <span>{{post.title}}</span>?
                            </div>
                            <a class="delete-article-cancel" href="">Cancel</a>
                            <a href="/delete-article/{{post.id}}">Confirm</a>
                        </div>
                        <form id="update-tags-{{post.id}}" class="update-article-tags" action="{% url 'editors:edit_article_tags' pk=post.id %}" method="post">
                            <div class="header">
                                <label for="tags-{{post.id}}">Edit tags</label>
                                <input type="text" name="tags" id="tags-{{post.id}}" value="{% for tag in post.tags.names %}{{tag|split:''}},{% endfor %}">
                            </div>
                            <div class="footer">
                                <a class="update-tags-cancel" href="">Cancel</a>
                                {% csrf_token %}
                                <input type="submit" value="Update">
                            </div>
                        </form>
                    </div>
                </div>
            {% empty %}
            <div class="post-summery" style="display:flex;align-items:center;color:var(--gray-color);border:none;padding-left:5px">No publications yet!</div>
            {% endfor %}
            {% include "pagination.html" with page=posts %}
        </div>
    </div>
    {% include "editors/create-container.html" %}
{% endblock content %}
{% block footer %}
<script>
    let changePics = document.querySelectorAll('form.image-wrapper>.avatar-upload')
    if(changePics != null){
        changePics.forEach((item,index)=>{
            let postId = item.dataset.id;
            let avatarEdit = item.querySelector(`.clock-${postId}`);
            let labelItem = item.querySelector(`#wrapper-${postId}`);

            labelItem.addEventListener('change',(e)=>{
                e.preventDefault()

                let file = e.target.files[0];
                let reader = new FileReader();
                reader.onloadend = function () {
                    avatarEdit.style.backgroundImage = "url(" + reader.result + ")";
                }
                if (file) {
                    reader.readAsDataURL(file);
                } else {
                }
            });
        })
    }
</script>
{% endblock footer%}
{% block domready %}
        // Delete-modals
        deleteBtns = document.querySelectorAll('a.delete-article')
        deleteModals = document.querySelectorAll('.delete-article-options')
        cancelBtns = document.querySelectorAll('a.delete-article-cancel')

        if (deleteBtns != null && deleteModals != null) {
            deleteBtns.forEach((deleteBtn,index)=>{
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault()
                    modal = deleteModals[index]
                    if (modal.style.display === 'grid') {
                        modal.style.setProperty('display', 'none')
                    }
                    else {
                        try{
                            deleteModals.forEach((deleteModal)=>{
                                deleteModal.style.display = 'none'
                            })
                        }
                        finally{
                            modal.style.setProperty('display', 'grid')
                        }
                    }
                })
            })
        }
        if (cancelBtns != null && deleteModals != null) {
            cancelBtns.forEach((cancelBtn,index)=>{
                cancelBtn.addEventListener('click',(e)=>{
                    e.preventDefault()
                    modal = deleteModals[index]
                    modal.style.setProperty('display', 'none')
                })
            })
        }


        //Update-tags-modals
        tagBtns = document.querySelectorAll('a.edit-article-tags')
        tagModals = document.querySelectorAll('.update-article-tags')


        if (tagBtns != null && tagModals != null) {
            tagBtns.forEach(tagBtn=>{
               const modal = document.querySelector(`form#update-tags-${tagBtn.dataset.id}`)
               const cancelBtn = modal.querySelector('a.update-tags-cancel')
                tagBtn.addEventListener('click', (e) => {
                    e.preventDefault()
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none'
                    }
                    else {
                        modal.style.setProperty('display', 'flex')
                        {% comment %} try{
                            tagModals.forEach((tagModal)=>{
                                tagModal.style.display = 'none'
                            })
                        }
                        finally{
                            modal.style.setProperty('display', 'flex')
                        } {% endcomment %}
                    }
                })
                cancelBtn.addEventListener('click',(e)=>{
                    e.preventDefault()
                    modal.style.setProperty('display', 'none')
                })
            })
        }
{% endblock domready %}
